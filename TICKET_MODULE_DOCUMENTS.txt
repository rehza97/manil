
1. Run database migration: alembic upgrade head
2. Install Trivy: sudo apt-get install trivy
3. Create upload directories: /var/lib/vps-uploads and /var/lib/vps-backups
4. Configure environment variables (S3, encryption keys)
5. Start Docker socket proxy: docker-compose -f docker-compose.security.yml up -d
6. Add custom image permissions to roles
7. Register the custom images router in main app





VPS Hosting Integration Verification & Fixes Plan

Executive Summary

Status: Backend is 90% integrated but has 3 critical issues preventing the custom Docker images feature from working. Frontend has complete VPS infrastructure but needs custom Docker images UI implementation.

---
PART 1: BACKEND INTEGRATION ISSUES (CRITICAL)

Issue 1: Custom Images Router Not Registered üî¥ HIGH PRIORITY

Problem: The custom_images router exists but is not imported or registered in main.py, making all custom image endpoints unreachable.

Impact:
- All 7 custom image endpoints return 404
- Feature is completely non-functional
- API calls from frontend will fail

Files to Fix:
- backend/app/main.py

Changes Required:

1. Add import after line 44:
from app.modules.hosting.routes.custom_images import router as custom_images_router

2. Register router after line 233:
app.include_router(custom_images_router, prefix="/api/v1/hosting")

Location: Lines 43-44 for import, Line 233 for registration

---
Issue 2: Database Dependency Import Error üî¥ HIGH PRIORITY

Problem: custom_images.py imports get_async_db which doesn't exist in database.py. Only get_db() exists.

Impact:
- Import error when starting the application
- Custom images routes will fail to load
- Application may not start properly

Files to Fix:
- backend/app/modules/hosting/routes/custom_images.py (9 occurrences on lines 48, 118, 185, 224, 272, 320, 354, 382, 421)

Changes Required:

Change all instances of:
from app.config.database import get_async_db
# ... and ...
db: AsyncSession = Depends(get_async_db)

To:
from app.config.database import get_db
# ... and ...
db: AsyncSession = Depends(get_db)

Alternative Solution: Add alias in backend/app/config/database.py:
get_async_db = get_db  # Alias for backward compatibility

---
Issue 3: Missing Service Exports üü° MEDIUM PRIORITY

Problem: New services (image_build_service, backup_service, billing_helpers) are not exported in services/__init__.py and routes/__init__.py.

Impact:
- Less clean imports (need full path instead of module import)
- Not following project conventions
- Minor inconsistency, but doesn't break functionality

Files to Fix:
- backend/app/modules/hosting/services/__init__.py
- backend/app/modules/hosting/routes/__init__.py

Changes Required:

1. In services/__init__.py, add after line 8:
from app.modules.hosting.services.image_build_service import DockerImageBuildService
from app.modules.hosting.services.backup_service import VPSBackupService
from app.modules.hosting.services.billing_helpers import BillingCalculator

2. Update __all__ list (line 11):
__all__ = [
    "DockerManagementService",
    "VPSProvisioningService",
    "SubscriptionBillingService",
    "ContainerMonitoringService",
    "DockerImageBuildService",
    "VPSBackupService",
    "BillingCalculator",
]

3. In routes/__init__.py, add after line 7:
from app.modules.hosting.routes.custom_images import router as custom_images_router

4. Update __all__ list (line 9):
__all__ = ["client_router", "admin_router", "custom_images_router"]

---
PART 2: BACKEND VERIFICATION (All Working ‚úÖ)

What's Already Properly Integrated:

‚úÖ Models & Database:
- CustomDockerImage model defined (lines 419-537 in models.py)
- ImageBuildLog model defined (lines 539-574 in models.py)
- ImageBuildStatus enum defined (lines 83-92 in models.py)
- All relationships configured correctly
- Migration file exists: 031_create_custom_docker_images.py

‚úÖ Services:
- DockerImageBuildService implemented (950 lines)
- VPSBackupService implemented (500 lines)
- BillingCalculator implemented (370 lines)
- All methods functional

‚úÖ API Routes:
- 7 endpoints defined in custom_images.py
- Proper permissions (@require_permissions decorators)
- Proper schemas (CustomImageResponse, etc.)

‚úÖ Celery Tasks:
- build_docker_image_task implemented in tasks.py
- backup_all_vps_task implemented in tasks.py
- Properly integrated with retry logic

‚úÖ Schemas:
- All Pydantic schemas defined in schemas.py
- Request/response validation ready

---
PART 3: FRONTEND IMPLEMENTATION NEEDED

What Exists:

‚úÖ Complete VPS Infrastructure:
- Service layer: vpsService.ts
- Types: hosting.types.ts
- Hooks: useVPSSubscriptions.ts, useVPSAdmin.ts, etc.
- Components: VPSPlanCard, VPSStatusBadge, ResourceGauge, etc.
- Pages: VPSPlansPage, MyVPSPage, VPSInstancePage, Admin pages
- Routes: All configured in routes.tsx

What's Missing (Custom Docker Images):

1. Types (frontend/src/modules/hosting/types/hosting.types.ts)

Add new interfaces:
export enum ImageBuildStatus {
  PENDING = 'PENDING',
  VALIDATING = 'VALIDATING',
  BUILDING = 'BUILDING',
  SCANNING = 'SCANNING',
  COMPLETED = 'COMPLETED',
  FAILED = 'FAILED',
  REJECTED = 'REJECTED'
}

export interface CustomDockerImage {
  id: string;
  customer_id: string;
  subscription_id?: string;
  image_name: string;
  image_tag: string;
  docker_image_id?: string;
  upload_filename: string;
  upload_size_bytes: number;
  dockerfile_path: string;
  status: ImageBuildStatus;
  build_started_at?: string;
  build_completed_at?: string;
  build_duration_seconds?: number;
  build_error?: string;
  image_size_mb?: number;
  security_scan_results?: SecurityScanResults;
  scan_completed_at?: string;
  version: number;
  is_deleted: boolean;
  created_at: string;
  updated_at: string;
}

export interface ImageBuildLog {
  id: string;
  image_id: string;
  timestamp: string;
  log_level: string;
  message: string;
  step?: string;
}

export interface SecurityScanResults {
  status: string;
  total_vulnerabilities: number;
  vulnerabilities_by_severity: {
    CRITICAL: number;
    HIGH: number;
    MEDIUM: number;
    LOW: number;
  };
  vulnerabilities: Array<{
    id: string;
    package: string;
    severity: string;
    title: string;
    fixed_version?: string;
  }>;
}

2. Service Methods (frontend/src/modules/hosting/services/vpsService.ts)

Add to vpsService object:
// Custom Docker Images
uploadCustomImage: async (
  file: File,
  metadata: {
    image_name?: string;
    image_tag?: string;
    dockerfile_path?: string;
    build_args?: Record<string, string>;
    subscription_id?: string;
  }
) => {
  const formData = new FormData();
  formData.append('file', file);
  if (metadata.image_name) formData.append('image_name', metadata.image_name);
  if (metadata.image_tag) formData.append('image_tag', metadata.image_tag);
  if (metadata.dockerfile_path) formData.append('dockerfile_path', metadata.dockerfile_path);
  if (metadata.build_args) formData.append('build_args', JSON.stringify(metadata.build_args));
  if (metadata.subscription_id) formData.append('subscription_id', metadata.subscription_id);

  return apiClient.post('/api/v1/hosting/custom-images/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
},

listCustomImages: async (filters?: {
  page?: number;
  page_size?: number;
  status?: ImageBuildStatus;
  subscription_id?: string;
}) => {
  return apiClient.get('/api/v1/hosting/custom-images', { params: filters });
},

getCustomImage: async (imageId: string) => {
  return apiClient.get(`/api/v1/hosting/custom-images/${imageId}`);
},

getImageBuildLogs: async (imageId: string, step?: string) => {
  return apiClient.get(`/api/v1/hosting/custom-images/${imageId}/logs`, {
    params: step ? { step } : undefined
  });
},

rebuildCustomImage: async (imageId: string, buildArgs?: Record<string, string>) => {
  return apiClient.post(`/api/v1/hosting/custom-images/${imageId}/rebuild`, {
    build_args: buildArgs
  });
},

deleteCustomImage: async (imageId: string) => {
  return apiClient.delete(`/api/v1/hosting/custom-images/${imageId}`);
},

approveOrRejectImage: async (imageId: string, approved: boolean, reason?: string) => {
  return apiClient.post(`/api/v1/hosting/custom-images/${imageId}/approve`, {
    approved,
    reason
  });
}

3. React Query Hooks (NEW FILE: frontend/src/modules/hosting/hooks/useCustomImages.ts)

Create complete hooks file with:
- useCustomImages() - List with filters
- useCustomImage() - Get single image
- useImageBuildLogs() - Get logs
- useUploadCustomImage() - Upload mutation
- useRebuildCustomImage() - Rebuild mutation
- useDeleteCustomImage() - Delete mutation
- useApproveCustomImage() - Admin approval mutation

4. Components (frontend/src/modules/hosting/components/)

Create 6 new components:
- ImageUploadForm.tsx - File upload with metadata
- ImageBuildStatusBadge.tsx - Status indicator
- ImageBuildLogsViewer.tsx - Build logs display
- CustomImageCard.tsx - Image summary card
- CustomImageDetailPanel.tsx - Full details
- ImageBuildProgressIndicator.tsx - Progress visualization

5. Pages (frontend/src/modules/hosting/pages/)

Create 4 new pages:
- CustomImagesPage.tsx - Client image list
- CustomImageDetailPage.tsx - Client image details
- ImageUploadPage.tsx - Upload form page
- AdminCustomImagesPage.tsx (in admin/pages/hosting/) - Admin management

6. Routes (frontend/src/app/routes.tsx)

Add new routes:
// Client routes
{
  path: 'vps/custom-images',
  element: <CustomImagesPage />
},
{
  path: 'vps/custom-images/upload',
  element: <ImageUploadPage />
},
{
  path: 'vps/custom-images/:imageId',
  element: <CustomImageDetailPage />
},

// Admin routes
{
  path: 'hosting/custom-images',
  element: <AdminCustomImagesPage />
},

---
IMPLEMENTATION PRIORITY

Phase 1: Backend Critical Fixes (30 minutes) üî¥ URGENT

1. Fix router registration in main.py
2. Fix get_async_db import error
3. Test that API endpoints are accessible

Phase 2: Backend Optional Improvements (15 minutes) üü°

1. Add service exports to init.py files
2. Follow project conventions

Phase 3: Frontend Implementation (8-12 hours) üîµ

1. Add types (30 min)
2. Add service methods (1 hour)
3. Create hooks (2 hours)
4. Build components (3-4 hours)
5. Create pages (2-3 hours)
6. Add routes (30 min)
7. Test integration (1-2 hours)

---
TESTING CHECKLIST

Backend Testing

- Start application without errors
- Access custom images endpoints:
  - POST /api/v1/hosting/custom-images/upload
  - GET /api/v1/hosting/custom-images
  - GET /api/v1/hosting/custom-images/{id}
  - GET /api/v1/hosting/custom-images/{id}/logs
  - POST /api/v1/hosting/custom-images/{id}/rebuild
  - DELETE /api/v1/hosting/custom-images/{id}
  - POST /api/v1/hosting/custom-images/{id}/approve
- Upload test image and verify build process
- Check Celery task execution

Frontend Testing

- Navigate to custom images page
- Upload image via form
- View image list
- View image details
- View build logs
- Rebuild image
- Delete image
- Admin: approve/reject image
- Create VPS with custom image

---
FILES REQUIRING CHANGES

Backend (Critical - Phase 1)

1. backend/app/main.py - Add router registration
2. backend/app/modules/hosting/routes/custom_images.py - Fix imports

Backend (Optional - Phase 2)

3. backend/app/modules/hosting/services/__init__.py - Add exports
4. backend/app/modules/hosting/routes/__init__.py - Add exports

Frontend (Phase 3)

5. frontend/src/modules/hosting/types/hosting.types.ts - Add types
6. frontend/src/modules/hosting/services/vpsService.ts - Add methods
7. frontend/src/modules/hosting/hooks/useCustomImages.ts - NEW FILE
8. frontend/src/modules/hosting/components/ImageUploadForm.tsx - NEW FILE
9. frontend/src/modules/hosting/components/ImageBuildStatusBadge.tsx - NEW FILE
10. frontend/src/modules/hosting/components/ImageBuildLogsViewer.tsx - NEW FILE
11. frontend/src/modules/hosting/components/CustomImageCard.tsx - NEW FILE
12. frontend/src/modules/hosting/components/CustomImageDetailPanel.tsx - NEW FILE
13. frontend/src/modules/hosting/components/ImageBuildProgressIndicator.tsx - NEW FILE
14. frontend/src/modules/hosting/pages/CustomImagesPage.tsx - NEW FILE
15. frontend/src/modules/hosting/pages/CustomImageDetailPage.tsx - NEW FILE
16. frontend/src/modules/hosting/pages/ImageUploadPage.tsx - NEW FILE
17. frontend/src/modules/admin/pages/hosting/AdminCustomImagesPage.tsx - NEW FILE
18. frontend/src/app/routes.tsx - Add routes

---
CONCLUSION

Backend Status: 90% complete - 2 critical issues preventing functionality
Frontend Status: 0% complete - Full implementation needed (expected)

Recommendation: Fix backend critical issues first (Phase 1), then implement frontend (Phase 3). Phase 2 is optional but recommended for consistency.

Estimated Total Time:
- Backend fixes: 30-45 minutes
- Frontend implementation: 8-12 hours
- Total: 9-13 hours






¬†‚òí Add CustomDockerImage types to hosting.types.ts
‚òê Add custom image service methods to vpsService.ts
‚òê Create useCustomImages.ts hooks file
‚òê Build ImageUploadForm component
‚òê Build ImageBuildStatusBadge component
‚òê Build ImageBuildLogsViewer component
‚òê Build CustomImageCard component
‚òê Build CustomImageDetailPanel component
‚òê Create CustomImagesPage
‚òê Create CustomImageDetailPage
‚òê Create ImageUploadPage
‚òê Add routes to routes.tsx